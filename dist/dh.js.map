{"version":3,"sources":["../src/dh.js"],"names":["moment","DeviceHiveClient","login","password","serverURL","token","__socket","WebSocket","authInfo","Promise","resolve","addEventListener","event","Error","send","JSON","stringify","action","targets","deviceId","dateRange","extractedTargets","slice","reduce","obj","item","type","path","dataPath","scale","refId","types","Object","keys","results","request","length","commandNotificationHandler","messageData","parse","data","actions","split","includes","datas","forEach","points","__extractValue","push","utc","timestamp","format","sort","a","b","target","datapoints","pointsX","pointsY","pointsZ","map","value","azimuth","roll","pitch","Math","cos","sin","removeEventListener","reject","createTokenPair","__authenticate","authHandler","status","__tokenMessage","then","accessToken","console","log","tokens","refreshToken","object","current","fields","filter","elem","field","undefined"],"mappings":"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","file":"dh.js","sourcesContent":["import moment from 'moment';\n\nexport default class DeviceHiveClient {\n  /**\n   * Creates an instance of DeviceHiveClient.\n   * @param {Object} { login, password, serverURL, token } \n   * @memberof DeviceHiveClient\n   */\n  constructor({ login, password, serverURL, token }){\n    if (serverURL && ((login && password) || token )) {\n      this.__socket = new WebSocket(serverURL);\n      this.authInfo = {\n        login,\n        password,\n        token\n      };\n      return new Promise((resolve) => {\n        this.__socket.addEventListener(`open`, (event) => {\n          resolve(this);\n        })\n      })\n    } else {\n      throw new Error(`You need to specify URL, login and password or token`);\n    }\n  }\n\n  /**\n   * Create token pair based on login\\password auth\n   * \n   * @param {String} login \n   * @param {String} password \n   * @memberof DeviceHiveClient\n   */\n  createTokenPair(login, password){\n    this.__socket.send(JSON.stringify({\n      action : `token`,\n      login,\n      password\n    }));\n  }\n\n  /**\n   * Query data by passed params\n   * \n   * @param {Array[Object]} targets \n   * @param {String} deviceId \n   * @param {Object} dateRange \n   * @returns \n   * @memberof DeviceHiveClient\n   */\n  queryData(targets, deviceId, dateRange){\n    return new Promise((resolve) => {\n      const extractedTargets = targets\n        .slice(0)\n        .reduce((obj, item) => {\n          if (!obj[item.type]){\n            obj[item.type] = [{ path : item.dataPath, scale : item.scale === `` ? 1 : item.scale, refId : item.refId }];\n          } else {\n            obj[item.type] = [\n              ...obj[item.type],\n              {\n                path : item.dataPath,\n                scale : item.scale === `` ? 1 : item.scale,\n                refId : item.refId\n              }\n            ];\n          }\n          return obj;\n        }, {});\n      const types = Object.keys(extractedTargets);\n      const results = [];\n      let request = types.length;\n      const commandNotificationHandler = (event) => {\n        const messageData = JSON.parse(event.data);\n        const actions = messageData.action.split(`/`);\n        if (types.includes(actions[0]) && actions[1] === `list`){\n          request--;\n          const datas = messageData[`${actions[0]}s`];\n          extractedTargets[actions[0]].forEach(({ path, scale, refId }) => {\n            if (!path.includes(`Orient`)){\n              const points = [];\n              datas.forEach(data => {\n                if (typeof this.__extractValue(data, path) !== `object`){\n                  points.push([this.__extractValue(data, path) * scale, +moment.utc(data.timestamp).format(`x`)]);\n                }\n              });\n              points.sort((a, b) => a[1] - b[1]);\n              results.push({\n                target : `${actions[0]}${refId}`,\n                datapoints : points\n              })\n            } else {\n              const pointsX = [];\n              const pointsY = [];\n              const pointsZ = [];\n              datas.forEach(data => {\n                if (typeof this.__extractValue(data, path) !== `object`){\n                  const [azimuth, roll, pitch] = this.__extractValue(data, path).split(`,`).map(value => +value);\n                  pointsX.push([-Math.cos(azimuth)*Math.sin(pitch)*Math.sin(roll) - Math.sin(azimuth)*Math.cos(roll), +moment.utc(data.timestamp).format(`x`)]);\n                  pointsY.push([-Math.sin(azimuth)*Math.sin(pitch)*Math.sin(roll) + Math.cos(azimuth)*Math.cos(roll), +moment.utc(data.timestamp).format(`x`)]);\n                  pointsZ.push([Math.cos(pitch)*Math.sin(roll), +moment.utc(data.timestamp).format(`x`)]);\n                }\n              });\n              pointsX.sort((a, b) => a[1] - b[1]);\n              pointsY.sort((a, b) => a[1] - b[1]);\n              pointsZ.sort((a, b) => a[1] - b[1]);\n\n              results.push({\n                target : `X`,\n                datapoints : [[pointsX[0][0]], [0]]\n              });\n              results.push({\n                target : `Y`,\n                datapoints : [[pointsY[0][0]], [0]]\n              });\n              results.push({\n                target : `Z`,\n                datapoints : [[pointsZ[0][0]], [0]]\n              });\n            }\n          })\n          if (!request){\n            this.__socket.removeEventListener(`message`, commandNotificationHandler);\n            resolve({\n              data : results\n            })\n          }\n        }\n      }\n      this.__socket.addEventListener(`message`, commandNotificationHandler);\n      types.forEach(type => \n        this.__socket.send(JSON.stringify({\n          action : `${type}/list`,\n          deviceId : deviceId\n        }))\n      );\n    })\n  }\n\n  /**\n   * Function used to test datasource connection and auth\n   * \n   * @returns \n   * @memberof DeviceHiveClient\n   */\n  testDatasource(){\n    return new Promise((resolve, reject) => {\n      if (!this.authInfo.token){\n        this.createTokenPair(this.authInfo.login, this.authInfo.password);\n      } else {\n        this.__authenticate(this.authInfo.token);\n      }\n      const authHandler = (event) => {\n        const messageData = JSON.parse(event.data);\n        if ((messageData.action === `token` || messageData.action === `authenticate`) && messageData.status === `success`){\n          switch (messageData.action) {\n          case `token` : \n            return this.__tokenMessage(messageData)\n            .then((accessToken) => this.__authenticate(accessToken));\n          case `authenticate`:\n            this.__socket.removeEventListener(`message`, authHandler);\n            return resolve();\n          }\n        } else {\n          if (messageData.status === `error`){\n            console.log(messageData);\n            this.__socket.removeEventListener(`message`, authHandler);\n            reject(messageData);\n          }\n        }\n      }\n      this.__socket.addEventListener(`message`, authHandler);\n    })\n  }\n\n  /**\n   * Internal handler on `token` type message\n   * \n   * @param {Object} messageData \n   * @returns \n   * @memberof DeviceHiveClient\n   */\n  __tokenMessage(messageData){\n    this.tokens = {\n      accessToken : messageData.accessToken,\n      refreshToken : messageData.refreshToken\n    }\n    return Promise.resolve(this.tokens.accessToken);\n  }\n  \n  /**\n   * Internal `authenticate` message sender\n   * \n   * @param {String} accessToken \n   * @memberof DeviceHiveClient\n   */\n  __authenticate(accessToken){\n    this.__socket.send(JSON.stringify({\n      action : `authenticate`,\n      token : accessToken\n    }));\n  }\n\n  /**\n   * Internal function to extract value from object based on path\n   * \n   * @param {Object} object \n   * @param {String} path \n   * @returns \n   * @memberof DeviceHiveClient\n   */\n  __extractValue(object, path){\n    let current = object;\n    const fields = path.split(/[\\.\\[\\]]/).filter(elem => elem !== ``);\n    fields.forEach(field => {\n      if (current[field] !== undefined){\n        current = current[field];\n      } else {\n        current = null;\n      }\n    })\n    return (typeof current === `string` && !path.includes(`Orient`)) ? +current : current;\n  }\n}\n"]}