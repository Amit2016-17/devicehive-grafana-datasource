{"version":3,"sources":["../../src/dh.js"],"names":["DeviceHiveClient","login","password","serverURL","token","__socket","WebSocket","authInfo","Promise","resolve","addEventListener","event","Error","send","JSON","stringify","action","targets","deviceId","dateRange","extractedTargets","slice","reduce","obj","item","type","path","dataPath","scale","refId","types","Object","keys","results","request","length","commandNotificationHandler","messageData","parse","data","actions","split","includes","datas","forEach","points","__extractValue","push","utc","timestamp","format","sort","a","b","target","datapoints","pointsX","pointsY","pointsZ","map","value","azimuth","roll","pitch","removeEventListener","reject","createTokenPair","__authenticate","authHandler","status","__tokenMessage","then","accessToken","console","log","tokens","refreshToken","object","current","fields","filter","elem","field","undefined"],"mappings":"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","file":"dh.js","sourcesContent":["import moment from 'moment';\r\n\r\nexport default class DeviceHiveClient {\r\n  /**\r\n   * Creates an instance of DeviceHiveClient.\r\n   * @param {Object} { login, password, serverURL, token } \r\n   * @memberof DeviceHiveClient\r\n   */\r\n  constructor({ login, password, serverURL, token }){\r\n    if (serverURL && ((login && password) || token )) {\r\n      this.__socket = new WebSocket(serverURL);\r\n      this.authInfo = {\r\n        login,\r\n        password,\r\n        token\r\n      };\r\n      return new Promise((resolve) => {\r\n        this.__socket.addEventListener(`open`, (event) => {\r\n          resolve(this);\r\n        })\r\n      })\r\n    } else {\r\n      throw new Error(`You need to specify URL, login and password or token`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create token pair based on login\\password auth\r\n   * \r\n   * @param {String} login \r\n   * @param {String} password \r\n   * @memberof DeviceHiveClient\r\n   */\r\n  createTokenPair(login, password){\r\n    this.__socket.send(JSON.stringify({\r\n      action : `token`,\r\n      login,\r\n      password\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Query data by passed params\r\n   * \r\n   * @param {Array[Object]} targets \r\n   * @param {String} deviceId \r\n   * @param {Object} dateRange \r\n   * @returns \r\n   * @memberof DeviceHiveClient\r\n   */\r\n  queryData(targets, deviceId, dateRange){\r\n    return new Promise((resolve) => {\r\n      const extractedTargets = targets\r\n        .slice(0)\r\n        .reduce((obj, item) => {\r\n          if (!obj[item.type]){\r\n            obj[item.type] = [{ path : item.dataPath, scale : item.scale === `` ? 1 : item.scale, refId : item.refId }];\r\n          } else {\r\n            obj[item.type] = [\r\n              ...obj[item.type],\r\n              {\r\n                path : item.dataPath,\r\n                scale : item.scale === `` ? 1 : item.scale,\r\n                refId : item.refId\r\n              }\r\n            ];\r\n          }\r\n          return obj;\r\n        }, {});\r\n      const types = Object.keys(extractedTargets);\r\n      const results = [];\r\n      let request = types.length;\r\n      const commandNotificationHandler = (event) => {\r\n        const messageData = JSON.parse(event.data);\r\n        const actions = messageData.action.split(`/`);\r\n        if (types.includes(actions[0]) && actions[1] === `list`){\r\n          request--;\r\n          const datas = messageData[`${actions[0]}s`];\r\n          extractedTargets[actions[0]].forEach(({ path, scale, refId }) => {\r\n            if (!path.includes(`Orient`)){\r\n              const points = [];\r\n              datas.forEach(data => {\r\n                if (typeof this.__extractValue(data, path) !== `object`){\r\n                  points.push([this.__extractValue(data, path) * scale, +moment.utc(data.timestamp).format(`x`)]);\r\n                }\r\n              });\r\n              points.sort((a, b) => a[1] - b[1]);\r\n              results.push({\r\n                target : `${actions[0]}${refId}`,\r\n                datapoints : points\r\n              })\r\n            } else {\r\n              const pointsX = [];\r\n              const pointsY = [];\r\n              const pointsZ = [];\r\n              datas.forEach(data => {\r\n                if (typeof this.__extractValue(data, path) !== `object`){\r\n                  const [azimuth, roll, pitch] = this.__extractValue(data, path).split(`,`).map(value => +value);\r\n                  pointsX.push([azimuth, +moment.utc(data.timestamp).format(`x`)]);\r\n                  pointsY.push([pitch, +moment.utc(data.timestamp).format(`x`)]);\r\n                  pointsZ.push([roll, +moment.utc(data.timestamp).format(`x`)]);\r\n                }\r\n              });\r\n              pointsX.sort((a, b) => a[1] - b[1]);\r\n              pointsY.sort((a, b) => a[1] - b[1]);\r\n              pointsZ.sort((a, b) => a[1] - b[1]);\r\n\r\n              results.push({\r\n                target : `X`,\r\n                datapoints : [[pointsX[0][0]], [0]]\r\n              });\r\n              results.push({\r\n                target : `Y`,\r\n                datapoints : [[pointsY[0][0]], [0]]\r\n              });\r\n              results.push({\r\n                target : `Z`,\r\n                datapoints : [[pointsZ[0][0]], [0]]\r\n              });\r\n            }\r\n          })\r\n          if (!request){\r\n            this.__socket.removeEventListener(`message`, commandNotificationHandler);\r\n            resolve({\r\n              data : results\r\n            })\r\n          }\r\n        }\r\n      }\r\n      this.__socket.addEventListener(`message`, commandNotificationHandler);\r\n      types.forEach(type => \r\n        this.__socket.send(JSON.stringify({\r\n          action : `${type}/list`,\r\n          deviceId : deviceId\r\n        }))\r\n      );\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Function used to test datasource connection and auth\r\n   * \r\n   * @returns \r\n   * @memberof DeviceHiveClient\r\n   */\r\n  testDatasource(){\r\n    return new Promise((resolve, reject) => {\r\n      if (!this.authInfo.token){\r\n        this.createTokenPair(this.authInfo.login, this.authInfo.password);\r\n      } else {\r\n        this.__authenticate(this.authInfo.token);\r\n      }\r\n      const authHandler = (event) => {\r\n        const messageData = JSON.parse(event.data);\r\n        if ((messageData.action === `token` || messageData.action === `authenticate`) && messageData.status === `success`){\r\n          switch (messageData.action) {\r\n          case `token` : \r\n            return this.__tokenMessage(messageData)\r\n              .then((accessToken) => this.__authenticate(accessToken));\r\n          case `authenticate`:\r\n            this.__socket.removeEventListener(`message`, authHandler);\r\n            return resolve();\r\n          }\r\n        } else {\r\n          if (messageData.status === `error`){\r\n            console.log(messageData);\r\n            this.__socket.removeEventListener(`message`, authHandler);\r\n            reject(messageData);\r\n          }\r\n        }\r\n      }\r\n      this.__socket.addEventListener(`message`, authHandler);\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Internal handler on `token` type message\r\n   * \r\n   * @param {Object} messageData \r\n   * @returns \r\n   * @memberof DeviceHiveClient\r\n   */\r\n  __tokenMessage(messageData){\r\n    this.tokens = {\r\n      accessToken : messageData.accessToken,\r\n      refreshToken : messageData.refreshToken\r\n    }\r\n    return Promise.resolve(this.tokens.accessToken);\r\n  }\r\n  \r\n  /**\r\n   * Internal `authenticate` message sender\r\n   * \r\n   * @param {String} accessToken \r\n   * @memberof DeviceHiveClient\r\n   */\r\n  __authenticate(accessToken){\r\n    this.__socket.send(JSON.stringify({\r\n      action : `authenticate`,\r\n      token : accessToken\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Internal function to extract value from object based on path\r\n   * \r\n   * @param {Object} object \r\n   * @param {String} path \r\n   * @returns \r\n   * @memberof DeviceHiveClient\r\n   */\r\n  __extractValue(object, path){\r\n    let current = object;\r\n    const fields = path.split(/[\\.\\[\\]]/).filter(elem => elem !== ``);\r\n    fields.forEach(field => {\r\n      if (current[field] !== undefined){\r\n        current = current[field];\r\n      } else {\r\n        current = null;\r\n      }\r\n    })\r\n    return (typeof current === `string` && !path.includes(`Orient`)) ? +current : current;\r\n  }\r\n}\r\n"]}