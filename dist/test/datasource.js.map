{"version":3,"sources":["../../src/datasource.js"],"names":["GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","jsonData","dhClientPromise","q","authType","authenticate","auth","serverURL","login","password","then","dhClient","token","options","newTargets","targets","forEach","execResults","_regex","exec","target","dataPath","push","slice","replace","RegExp","_index","current","value","scale","refId","queryData","deviceId","from","range","_d","to","result","testDatasource","Promise","resolve","status","message","title","catch","error"],"mappings":"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","file":"datasource.js","sourcesContent":["import DeviceHiveClient from './dh';\nimport _ from \"lodash\";\n\nexport class GenericDatasource {\n  /**\n   * Creates an instance of GenericDatasource.\n   * @param {Object} instanceSettings \n   * @param {any} $q \n   * @memberof GenericDatasource\n   */\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.jsonData = instanceSettings.jsonData;\n    this.dhClientPromise = null;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    \n    this.q = $q;\n    if (instanceSettings.jsonData){\n      if (instanceSettings.jsonData.authType === `Login/Password` || instanceSettings.jsonData.authType === `Token`){\n        this.authenticate(this.jsonData.authType, this.jsonData.auth, this.jsonData.serverURL);\n      }\n    }\n  }\n\n  /**\n   * Authenticates user\n   * \n   * @param {String} type \n   * @param {Object} auth \n   * @param {String} url \n   * @returns \n   * @memberof GenericDatasource\n   */\n  authenticate(type, auth, url){\n    if (type === `Login/Password`){\n      return this.dhClientPromise = new DeviceHiveClient({\n        login : auth.login,\n        password : auth.password,\n        serverURL : url\n      })\n      .then(dhClient => {\n        this.dhClient = dhClient;\n        return dhClient;\n      });\n    } else if (type === `Token`){\n      return this.dhClientPromise = new DeviceHiveClient({\n        token : auth.token,\n        serverURL : url\n      })\n      .then(dhClient => {\n        this.dhClient = dhClient;\n        return dhClient;\n      });\n    }\n  }\n\n  /**\n   * Function used by Grafana to query data\n   * \n   * @param {Object} options \n   * @returns \n   * @memberof GenericDatasource\n   */\n  query(options) {\n    const newTargets = [];\n    options.targets.forEach(target => {\n      const execResults = this.templateSrv._regex.exec(target.dataPath);\n      newTargets.push({\n        dataPath : target.dataPath.slice().replace(new RegExp(\"\\\\\" + `${execResults[0]}`), this.templateSrv._index[execResults[1]].current.value),\n        scale : target.scale,\n        refId : target.refId,\n        type : target.type\n      });\n    })\n    if (this.dhClient){\n      return this.dhClient\n        .queryData(newTargets, this.jsonData.deviceId, { from : options.range.from._d, to : options.range.to._d })\n        .then(result => {\n          return result;\n        });\n    } else {\n      return this.authenticate(this.jsonData.authType, this.jsonData.auth, this.jsonData.serverURL)\n      .then(dhClient => dhClient.testDatasource())\n      .then(() => {\n        return this.dhClient.queryData(newTargets, this.jsonData.deviceId, { from : options.range.from._d, to : options.range.to._d })\n      })\n      .then(result => {\n        return result;\n      });\n    }\n  }\n\n  /**\n   * Function used by Grafana to test datasource\n   * \n   * @returns \n   * @memberof GenericDatasource\n   */\n  testDatasource() {\n    return this.dhClientPromise\n      .then(dhClient => dhClient.testDatasource())\n      .then(() => Promise.resolve({ status : `success`, message : `Data source is working`, title : `Success` }))\n      .catch((message) => Promise.resolve({ status : `error`, message : message.error, title : `Error` }));\n  }\n}\n"]}